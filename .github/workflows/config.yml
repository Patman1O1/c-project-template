name: Initialize

on:
  push:
    branches: [main]
  create:

jobs:
  configure:
    # Make sure this is not the template repository
    if: github.repository != 'Patman1O1/c-project-template'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Initialize CMake files
        run: |
          # Extract repository information
          REPO_NAME="${{ github.event.repository.name }}"
          REPO_OWNER="${{ github.repository_owner }}"
          REPO_URL="${{ github.event.repository.html_url }}"
          
          # Configure .in files
          sed -i "s/@PROJECT_NAME@/${REPO_NAME}/g" CMakeLists.txt.in
          sed -i "s/@REPO_OWNER@/${REPO_OWNER}/g" config.h.in
          sed -i "s|@REPO_URL@|${REPO_URL}|g" config.h.in
          
          # Rename files (remove .in extension)
          mv CMakeLists.txt.in CMakeLists.txt
          mv config.h.in config.h

      - name: Commit changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add .
          git commit -m "Configure template for ${GITHUB_REPOSITORY}" || echo "No changes to commit"
          git push

      - name: Clean up workflow
        run: |
          # Optionally remove this workflow file after it runs once
          git rm .github/workflows/configure-template.yml
          git commit -m "Remove template configuration workflow"
          git push